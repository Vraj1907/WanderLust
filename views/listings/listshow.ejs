<% layout("/layouts/boilerplate") %>
  <script>
    // safe serialization: coordinates may be null for old listings
    const coordinates = <% - JSON.stringify(listing.geometry && Array.isArray(listing.geometry.coordinates) ? listing.geometry.coordinates : null) %>;
    const listing = <% - JSON.stringify(listing) %>;
  </script>

  <body>
    <div class="row mt-3">
      <div class="col-8 offset-3">
        <h3>
          <%=listing.title %>
        </h3>
      </div>

      <div class="card col-6 offset-3 show-card listing-card">
        <img src="<%= listing.image.url %>" class="card-img-top show-img" alt="listing_image">
        <div class="card-body">
          <div class="card-text">
            <p>Owned by <b><i>
                  <%= listing.owner.username %>
                </i></b></p>
            <p>
              <%= listing.description %>
            </p>
            <p>&#8377; <%= listing.price.toLocaleString("en-IN") %>
            </p>
            <p>
              <%= listing.location %>
            </p>
            <p>
              <%= listing.country %>
            </p>
          </div>
          <% if(currUser && listing.owner._id.equals(currUser._id)) { %>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div>
                <a href="/listings/<%= listing._id %>/edit"
                  class="btn btn-primary btn-lg px-4 rounded-pill shadow-sm me-2">
                  <i class="fa fa-edit me-2"></i>Edit
                </a>
                <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" class="d-inline">
                  <button class="btn btn-danger btn-lg px-4 rounded-pill shadow-sm"
                    onclick="return confirm('Are you sure you want to delete this listing?');">
                    <i class="fa fa-trash me-2"></i>Delete
                  </button>
                </form>
              </div>
              <a href="/listings/<%= listing.id %>/booking" class="btn btn-success btn-lg px-4 rounded-pill shadow-sm">
                <i class="fa fa-calendar-check me-2"></i>Book your Hotel
              </a>
            </div>
            <% } %>
        </div>

      </div>
    </div>
    <hr>
    <% if(currUser){%>

      <div mb-3 mt-3>


        <form class="col-8 offset-3 needs-validation" method="post" action="/listings/<%=listing._id%>/reviews"
          novalidate>
          <h4>Leave a Review</h4>



          <!-- review object an rating pass as an input value -->
          <div mb-3 mt-3>
            <label for="Rating" class="form-label">Review</label>
            <fieldset class="starability-slot">
              <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="0" checked
                aria-label="No rating." />
              <input type="radio" id="first-rate1" name="review[rating]" value="1" />
              <label for="first-rate1" title="Terrible">1 star</label>
              <input type="radio" id="first-rate2" name="review[rating]" value="2" />
              <label for="first-rate2" title="Not good">2 stars</label>
              <input type="radio" id="first-rate3" name="review[rating]" value="3" />
              <label for="first-rate3" title="Average">3 stars</label>
              <input type="radio" id="first-rate4" name="review[rating]" value="4" />
              <label for="first-rate4" title="Very good">4 stars</label>
              <input type="radio" id="first-rate5" name="review[rating]" value="5" />
              <label for="first-rate5" title="Amazing">5 stars</label>
            </fieldset>
          </div>


          <br>
          <div mb-3 mt-3>




            <label for="comment" class="form-label">Comment</label>
            <textarea name="review[comment]" id="comment" rows="5" cols="30" class="form-control" required></textarea>
            <div class="invalid-feedback">Please add comments</div>
            <br>
            <button class="btn btn-outline-dark">Submit</button>

        </form>
      </div>
      <% } %>
        </div>
        <div>
          <% if(listing.reviews.length>0) {%>
            <div class="row col-8 offset-3">
              <p><b>All Reviews</b></p>


              <%for(review of listing.reviews){%>
                <div class="card col-5 mb-3 ms-3">
                  <div class="card-body">


                    <h5 class="card-title">@<%= review.author.username %>
                    </h5>
                    <p class="starability-result card-text" data-rating="<%= review.rating %>">

                    </p>
                    <p class="card-text">
                      <%=review.comment%>
                    </p>

                  </div>
                  <br>
                  <form method="post" action="/listings/<%=listing._id%>/reviews/<%=review._id%>?_method=DELETE">
                    <button class="btn btn-sm btn-dark mb-3 col-3">Delete</button>
                  </form>

                </div>

                <% } %>
            </div>
            <% } %>
        </div>


        <div class="col-8 offset-3 mb-3">
          <h3>Where you'll be</h3>
          <div id="map"></div>
        </div>
        </div>


        <script src="/js/script.js"></script>
        <script>
          let mapToken = "<%= process.env.MAP_TOKEN %>";
          console.log(mapToken);
          mapboxgl.accessToken = mapToken;

          const map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/mapbox/streets-v12",
            center: listing.geometry.coordinates,
            zoom: 10,
          })
          console.log(coordinates);

          const marker = new mapboxgl.Marker({ color: "red" })
            .setLngLat(listing.geometry.coordinates)
            .setPopup(
              new mapboxgl.Popup({ offset: 25 }).setHTML(
                `<h4>${listing.title}</h4><p>Exact location will be provided after booking</p>`
              )
            )
            .addTo(map)

        </script>
        <script>
          // expose & clean token (server-rendered, trimmed)
          const token = <% - JSON.stringify((process.env.MAP_TOKEN || '').trim()) %>;
          const coords = coordinates; // from top
          const listingData = listing;

          if (!token) {
            console.warn('Mapbox token missing/empty â€” map will not load.');
            const el = document.getElementById('map'); if (el) el.style.minHeight = '0';
          } else if (!coords || !Array.isArray(coords) || coords.length !== 2) {
            console.warn('No valid coordinates for this listing; map hidden.', coords);
            const el = document.getElementById('map'); if (el) el.style.minHeight = '0';
          } else {
            // parse and ensure numeric [lng, lat]
            let lng = Number(coords[0]);
            let lat = Number(coords[1]);
            // if lat looks like longitude (>|90|) but lng is within lat range, swap
            if (Math.abs(lat) > 90 && Math.abs(lng) <= 90) [lng, lat] = [lat, lng];
            if (!isFinite(lng) || !isFinite(lat)) {
              console.warn('Coordinates are not numeric:', coords);
              const el = document.getElementById('map'); if (el) el.style.minHeight = '0';
            } else {
              try {
                mapboxgl.accessToken = token;
                const center = [lng, lat];
                const map = new mapboxgl.Map({
                  container: 'map',
                  style: 'mapbox://styles/mapbox/streets-v12',
                  center,
                  zoom: 12
                });

                new mapboxgl.Marker({ color: 'red' })
                  .setLngLat(center)
                  .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(
                    `<h4>${listingData.title}</h4><p>Exact location will be provided after booking</p>`
                  ))
                  .addTo(map);
              } catch (err) {
                console.error('Error initializing Mapbox map:', err);
                const el = document.getElementById('map'); if (el) el.style.minHeight = '0';
              }
            }
          }
        </script>

  </body>